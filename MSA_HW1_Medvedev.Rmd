---
title: "MCA_ДЗ1_Медведев"
author: "Виктор Медведев"
date: "7 октября 2020 г."
output: html_document
---

Загружаем пакеты для работы.

```{r, warning = FALSE, message = FALSE}
library(haven)
library(plm)
library(ggplot2)
library(dplyr)
library(lmtest)
library(sandwich)
```

Загружаем данные.

```{r, message=FALSE, warning=FALSE}
panel<-read_dta("MSA_hw1.dta")
attach(panel)
```

>##### Задание 1. Оцените регрессионную модель (без учета панельной структуры данных), в которой откликом выступает логарифм числа преступлений на человека, предикторами – логарифм числа полицейских на душу населения, логарифм плотности населения, процент небелого населения.

```{r}
ols <- plm(lncrime ~ lnpolice + lndensity + nonwhite, data = panel, model="pooling")
summary(ols)
```

**1.1** Проинтерпретируйте полученные результаты. В частности, сделайте вывод о характере взаимосвязи между зависимой переменной и объясняющими переменными.

Intercept: -3.346502 - среднее значение логарифма числа преступлений на человека при всех предикторах равных нулю. Константа является статистически значимой.

lnpolice: при увеличении на единицу измерения логарифма числа полицейских на душу населения в среднем логарифм числа преступлений на человека увеличивается на 0.137782 при прочих равных переменных. Коэффициент связи значим и обладает прямой положительной связью с зависимой переменной.

lndensity: при увеличении на едиинцу измерения логарифма плотности населения в среднем логарифм числа преступлений на человека увеличивается на 0.485777 при прочих равных переменных. Коэффициент связи значим и обладает прямой положительной связью с зависимой переменной.

nonwhite: при увеличении на единицу измерения логарифма процента небелого населения в среднем логарифм числа преступлений на человека увеличивается на 0.219439 при прочих равных переменных. Коэффициент связи значим и обладает прямой положительной связью с зависимой переменной.

**1.2** К чему может привести оценивание модели объединенной регрессии (pooled model) на массиве панельных данных?

Неверное оцениваение модели (pooled model) на массиве панельных данных может привести к двум важным следствиям: 

1. Aggregation bias. Не учитывая данные подгрупп, собирая их в единый пул данных, определяется неверная функциональная зависимость между предикторами и зависимой переменной.

2. Pooled regression не учитывает поправку на неоднородность данных, поэтому получаются заниженные стандартные ошибки, которые ведут к неверной jоценки значимости оценок.

>##### Задание 2. Оцените модель посредством МНК с фиктивными переменными (LSDV-модель с набором дамми-переменных на константы). Сравните полученные результаты с результатами модели, построенной без учета панельной структуры данных. Проинтерпретируйте оценки коэффициентов при трех любых статистически-значимых дамми-переменных.

Сделаем базовой категорией первый номер округа штата Каролина. 

```{r}
county_base <- relevel(factor(county), ref ="1")
LSDV <- lm(lncrime~lnpolice + lndensity + nonwhite + county_base, data = panel)
summary(LSDV)
```

В модели с фиктивными переменными сохранилось направление связи переменных с коэффициентами при предикторах lnpolice и nonwhite. При этом сменилось направление связи с коэффицеинтом при предикторе lndensity. Значимость сохранилась и у коэффициента при предикторе lnpolice, несклько уменьшилась, но сохранилась сильная у коэффициента при nonwhite и исчезла у коэффициента при предикторе, сменившего направление - lndensity. Константа сохранила значимость, но чуть изменила значение из-за учёта базовой категории. Сущенственно изменились оценки при предикторах nonwhite (с 0.21944 до 0.612488) и lnpolice (с 0.13778 до 0.213866).

county_base11: при переходе от базового (первого) округа штата (пространственной единицы) к 11 округу штата в среднем логарифм числа преступлений на человека увеличивается на 0.725701 при прочих равных предикторах.

county_base55: при переходе от базового округа штата к 55 округу штата в среднем логарифм числа преступлений на человека увеличивается на 0.926725 при прочих равных предикторах.

county_base169: при переходе от базового округа штата к 169 округу штата в среднем логарифм числа преступлений на человека уменьшается на 0.366547 при прочих равных предикторах.

>##### Задание 3. Оцените модель, используя внутригрупповое преобразование (withingroup transformation).

```{r}
fe_within <- plm(lncrime~lnpolice + lndensity + nonwhite + county_base,
                        data = panel, index=c("county", "year"), model="within")
summary(fe_within)
```

**3.1** Проинтерпретируйте полученные результаты. Сравните коэффициенты при предикторах с коэффициентами при соответствующих предикторах в модели с набором дамми-переменных на константы.

lnpolice: при увеличении на отклонение от среднего логарифма числа полицейских на душу населения в среднем отклонение от среднего логарифма числа преступлений на человека увеличивается на 0.213866 при прочих равных переменных. Коэффициент связи значим и обладает прямой связью с зависимой переменной.

lndensity: при увеличении на отклонение от среднего логарифма плотности населения в среднем отклонение от среднего логарифма числа преступлений на человека уменьшается на 0.05586 при прочих равных переменных. Коэффициент связи не значим и обладает прямой связью с зависимой переменной.

По факту мы получили те же самые оценки коэффициентов при предикторах с теме же самыми значениями (на тех же уровнях значимости), что и в LSDV модели, поскольку лишь выполнили преобразования, исключающие константы и дамми-переменные из нашей модели. Мы не получили 

**3.2** Коэффициент при каком предикторе не позволяет оценить модель с внутригрупповым преобразованием? Объясните, почему.

```{r}
panel %>%
group_by(county) %>%
summarize(var = var(nonwhite))
```

При внутригрупповом преобразовании зависимая переменная и предикторы представляют собой отклонения наблюдений от среднего значения по округу. Оказывается невозможным оценить коэффициент при предикторе nonwhite в модели с внутригрупповым преобразованием, так как он является константами для каждого округа, а значит вариация внутри групп оказывается равна нулю - отклонение конкретного значения всегда будет равно 0.

>##### Задание 4. Проверьте гипотезу о том, что все индивидуальные эффекты равны нулю. Сделайте вывод о том, какая модель более адекватна данным: модель с фиксированными эффектами или модель без учета панельной структуры.

Проверку pooled model и fixed effect model мы будем осуществлять на F-тесте. Гипотеза формулируется об отсутствии индивидуальных эффектов.

```{r}
pFtest(fe_within, ols)
```

Значение p-value стремится к нулю, а значит нулевая гипотеза об отсутствии индивидуальных эффектов отвергается в пользу альтернативной гипотезы, согласно которой мы должны учесть пространственную неоднородность, а значит предпочесть fixed effect model. 

>##### Задание 5. Оцените модель со случайными эффектами.

```{r}
re <- plm(lncrime~lnpolice + lndensity + nonwhite, 
          data = panel, index=c("county", "year"), model="random")
summary(re)
```

**5.1** Проверьте гипотезу о том, что дисперсия случайного индивидуального эффекта равна 0. В пользу какой модели Вы сделаете выбор: модели со случайными эффектами или модели без учета панельной структуры данных?

Проверка гипотезы о нулевой дисперсии случайного индивидуальных эффектов будет осуществляться на тесте Бреуша-Пагана.

```{r}
plmtest(ols, type=c("bp"))
```

Значение p-value стремится к нулю, а значит нулевая гипотеза об отсутствии дисперсии случайных индивидуальных эффектов будет отвергнута в пользу альтернативной гипотезы, согласно которой в данных присутствует статистически значимая неоднородность, а значит нам следует предпочесть random effects model.

**5.2** Сравните результаты с результатами модели с фиксированными эффектами. Какое допущение главным образом отличает RE-model от FE-model? Поразмышляйте, правдоподобно ли это допущение применительно к нашим данным (поясните, почему, проиллюстрируйте конкретным примером)?

Сохранение направления связи между коэффициентами при объясняющих переменных lnpolice и nonwhite и зависимой переменной, но смена направления связи у переменной lndensity при проверке REM против FEM. Сохранение значимости у коэффициента при lnpolice RE и отсутствие значимости этого коэффициента в FE, уменьшение значимости коэффициента nonwhite (в RE 0.221979 и 0.612488 в FE) и приобретение более высокой значимости коэффициента при lndensity, который потерял его в FE-model. Константа остаётся значимой. 

Главным образом RE-model отличается от FE-model допущением об отсутствии корреляции между случайным эффектом и предиктором ($Cov(\alpha_i, x_i) = 0$). Это вообще редко соблюдающееся допущение, так как внутри ошибки содержится необъяснённая вариация, связанная с пространственной неоднородностью. Если у нас разные вариации в подгруппах, то будет нарушаться условие гомоскедастичности и мы будем иметь неэффективные оценки. Вариации же непостоянны, когда пропускается какая-то систематическая переменная, а это то, что обуславливает наличие групп. В наших данных, скорее всего, есть часть ошибки, которая связана с ключевыми предикторами. Так переменная nonwhite отражает пространственную неоднородность - доля белых может быть больше в counties с более высокой стоимостью земли и меньшим количеством преступелний в силу лучшей обеспеченности социальной инфраструктурой (в том числе полицией и социальными службами) - и будет разной для разных пространственных единиц. 

**5.3** Протестируйте посредством теста Хаусмана отсутствие корреляции между индивидуальными эффектами и предикторами. Сделайте вывод. Назовите ограничения теста Хаусмана.

```{r}
phtest(fe_within, re) 
```

На уровне значимости 0.05 p-value является значимым, а значит нулевая гипотеза об отсутствии корреляции между индивидуальными эффектами и предикторами отвергается в пользу альтернативной гипотезы, согласно которой мы должны предпочесть fixed effect model. 

Ограничения теста Хаусмана:

1. Малая мощность теста, поэтому у него низкая объяснительная способность - невозможность распознавать малые корреляции.
2. Низкая потенциальная возможность статистической инференции, поэтому требуется содержательная интерпретация имеющегося датасета для выбора необходимой модели: выбор между FEM (неэффективными оценками) и REM (смещёнными и несостоятельными оценками).

>##### Задание 6. Протестируйте альтернативные спецификации модели: с включением временных эффектов и twoway model (с включением и пространственных, и временных эффектов). Объясните различия в интерпретации оценок коэффициентов при предикторах в разных моделях. Какая модель более адекватна в данном случае? Выбранную модель переоцените с поправкой на гетероскедастичность.

Модель с временными эффектами.

```{r}
tyear <- relevel(factor(year), ref ="81")
LSDV_t <- lm(lncrime~lnpolice + lndensity + nonwhite + tyear)
summary(LSDV_t)
```

В отличие от предыдущей FE-model мы фиксируем временную перспективу (и дамми-переменные будут формулироваться как "при переходе к n-году") и наблюдаем изменения в пространственной перспективе. Особенность интерпретации будет состоять лишь в изменении временной на пространственную перспективу изменений в отличие от предыдущей спецификации FE-model. В выдаче модели всё также нет nonwhite по тем же причинам, что и в FE с пространственными эффектами.

Исследовательский вопрос, основанный на специфике наших данных, лучше формулировать относительно пространственных эффектов FE-model. Связано это с тем, что нашей зависимой переменной выступает уровень преступлений, который неоднороден будет, скорее, в пространстве, а не в разные временные периоды, который к тому же ограничены 8 периодами. К тому же мы уже обладаем результатами формальных тестов, которые показали, что она лучше, чем альтернативные pooled и RE модели.

Введём twoway model.

```{r}
fe_twoways <- plm(lncrime~lnpolice + lndensity + nonwhite, data = panel, index=c("county", "year"), effect = "twoways", model = "within")
summary(fe_twoways)
```

Оценки при коэффициентах показывают усреднённое во времени и пространстве изменение. В частности, в нашем случае мы можем интерпретировать коэффициенты при предикторах как такие, что коэффициенты показывают в среднем изменение логарифма числа преступлений на человека при увеличении на единицу измерения как в межокружной (пространственной), так и временной перспетиве при прочих равных переменных. 

Сравним FE-model и twoways model.

```{r}
pFtest(fe_twoways, fe_within)
```

Значение p-value стремится к нулю, а значит нулевая гипотеза о незначимости фиксированных эффектов отвергается в пользу альтернативной гипотезы, согласно которой мы должны предпочесть более громоздкую модель с значимыми фиксированными эффектами - two-ways model. 

Проверим сначала с помощью теста Бреуша-Пагана модель на то, на какие ошибки стоит переоценить модель.

```{r}
bptest(fe_twoways) 
```

Малое p-value говорит о том, что мы должны использовать кластеризованные стандартные ошибки. Произведём переоценку модели с поправкой на гетероскастичность.

```{r}
coeftest(fe_twoways, vcov = vcovHC, type = "HC3")
```

Значимость предиктора lndensity была утеряна, а значимость lnpolice сохранилась, но стала значимой на уровне 0.001. Значимость коэффициентов стала схожей с той, что мы получили при оценке FE-model с пространственными эффектами. 

>##### Задание 7. Протестируйте, устойчива ли выбранная модель. Переоцените модель на усеченной выборке: без округов, в которых корреляция предсказанного отклика и наблюдаемого мала. Изменились ли значительно результаты?

Проверим на устойчивость выбранную модель.

```{r}
LSDV_twoways <- lm(lncrime~lnpolice + lndensity + nonwhite + as.factor(county) + as.factor(year), data = panel) 
y_pred <- LSDV_twoways$fitted 
panel_pred <- data.frame(panel, y_pred)
```

Переоценим модель на усечённой выборке без округов с малой корреляцией предсказанных и наблюдаемых зависимых переменных.

```{r}
merged <- panel_pred %>% group_by(county)%>% summarize(., cor(lncrime, y_pred))%>% merge(panel_pred, ., by="county")
head(merged)
merged$new <- ifelse(abs(merged$`cor(lncrime, y_pred)`)<0.3,1,0)
fe_twoways_2 <- plm(lncrime~lnpolice + lndensity + nonwhite, merged[merged$new == 0,], index=c("county", "year"), effect = "twoways")
coeftest(fe_twoways_2, vcov = vcovHC, type = "HC3")
```

Полученные результаты свидетельствуют об относительной устойчивости оценённой модели. Вновь значимым (на уровне значимости 0.05) стал предиктор lndensity. Также были сохранены характеры взаимосвязи предикторов с зависимой переменной. Оценённые значения коэффициентов при предикторах немного увеличились: оценка коэффициента при lndensity увеличилась с 0.835914 до 1.158429, а при lnpolice с 0.237944 до 0.259732.

>##### Выводы

В результате серии тестов мы определили, что лучшей моделью является two-way model. После переоценки мы получили значимые коэффициенты при lnpolice и lndensity. Значимость приобрёл коэффициент предиктора lndensity, поскольку мы удалили наблюдения, которые имели малую корреляцию между наблюдаемыми и предсказанными значениями. Также мы проверили модель на усечённой выборке и устойчивых к гетероскедастичности ошибках. Модель содержательна оправдана для FE моделей, так как исследовательский вопрос лучше сформулировать как "что оказывает влияние на уровень преступности между различными округами Каролины". Данные имеют и пространственное, и временное измерение, а также есть удовлетворительное число наблюдений, поэтому есть возможность для two-way model, которая может претендовать на каузальность. С другой стороны, полученная модель ограничена тем, что мы оказываемся связаны в возможностях статической инференции, а также несколько неясно, как можем интерпретировать полученные оценки.

>##### Бонусное задание.

**8.1** Оцените регрессионную модель с фиксированными эффектами на константу, в которой откликом является по-прежнему логарифм числа преступлений на человека, а предиктор только один – логарифм плотности населения. Покажите, как получить оценку коэффициента при данном предикторе на основе оценок коэффициентов регрессионных моделей, оцененных на отдельных подгруппах (округа формируют подгруппы). В каком случае подгруппа (в данном случае – округ) не учитывается (то есть, не имеет веса) при расчете оценки коэффициента модели с фиксированными эффектами?

```{r}
LSDV_bonus <- plm(data = panel, lncrime ~ lndensity, index=c("county", "year"), effect = "individual")
summary(LSDV_bonus)
```

```{r}
a <- group_by(panel, county) %>%
  do(data.frame(beta = coef(lm( lncrime ~ lndensity, data = .))[2]))
a

var <- summarize(group_by(panel, county), var(lndensity))
m <- as.data.frame(merge(a, var, by ="county"))

m$coef <- m$beta*(m$`var(lndensity)`/sum(m$`var(lndensity)`))
sum(m$coef)

plm(data = panel, lncrime ~ lndensity, index=c("county", "year"))$coefficients
```

Не обладают весом при подсчёте коэффициента те подгруппы, в которых вариация предиктора подгруппы равна 0 или не имеет наблюдений. 

**8.2** Покажите, как в случае множественной регрессии получить оценку коэффициента при предикторе «логарифм плотности населения» на основе оценок коэффициентов регрессионных моделей, оцененных на отдельных подгруппах (округа формируют подгруппы). Как формируются веса для коэффициентов по отдельным подгруппам (округам) в случае, если мы оцениваем множественную регрессию (включаем больше одного предиктора)? Критически прокомментируйте такую процедуру взвешивания.

```{r}
y_c <- plm(data = panel, lncrime ~ lnpolice, index=c("county", "year"), effect = "individual", model = "within")$residuals
lndensity_c <- plm(data = panel, lndensity  ~ lnpolice, index=c("county", "year"), effect = "individual", model = "within")$residuals

y_c <- panel$lncrime - lm(data = panel, lncrime ~ lnpolice  + factor(county))$fitted
lndensity_c <- panel$lndensity -  lm(data = panel, lndensity  ~ lnpolice + factor(county))$fitted 

b <- group_by(panel, county) %>%
  do(data.frame(beta = coef(lm(y_c ~ lndensity_c, data = .))[2]))

var <- summarize(group_by(panel, county), var(lndensity_c))
n <- as.data.frame(merge(b, var, by ="county"))

n$coef <- n$beta*(n$`var(lndensity_c)`/sum(n$`var(lndensity_c)`))

sum(n$coef)
coef(plm(data = panel, lncrime ~ lnpolice + lndensity, index=c("county", "year"), effect = "individual", model = "within"))
```
Мы разбиваем модель по подгруппам, в которых оцениваем регрессии, очищая переменные от влияния остальных ключевых и контрольных переменных. С помощью очищенных переменных получаем коэффициенты для подгрупп. Далее считаем полученные коэффициенты умножаем на вариации предикторов их подгрупп и делим на сумму вариаций предиктора. 

У такого взвешивания есть свои проблемы: больший вес оказывается у тех коэффициентов по подгруппам, где больший разброс данных (менее стабильные оценки), а недооцениваются подгруппы, где есть недостаток данных.